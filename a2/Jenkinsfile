pipeline {
    agent { label 'jenkins-agent' }

    environment {
        APP_IMAGE_NAME = 'ravinderjit/assignment2'

        DOCKER_CREDS_ID = 'dockerhub-creds'
        DOCKER_BIN = '/usr/bin/docker'

        KUBECTL_BIN = '/usr/local/bin/kubectl'
            
        K8S_MANIFEST_FILE = 'k8s-manifest.yaml'
        K8S_NAMESPACE = 'rgill201' // Namespace in k8s-manifest.yaml
        K8S_DEPLOYMENT_NAME = 'a2-deployment' // Deployment resource to check rollout status
    }

    stages {
        stage('Clone Source Code') {
            steps {
                // Clones the repo containing the Jenkinsfile and the application source code/manifests
                checkout scm
            }
        }

        stage('Build Image') {
            steps {
                dir('a2') {
                    sh "${DOCKER_BIN} build -t ${APP_IMAGE_NAME}:latest ."
                }
            }
        }
        
        stage('Push to Docker Hub') {
            steps {
                withCredentials([usernamePassword(credentialsId: DOCKER_CREDS_ID,
                                                 usernameVariable: 'DOCKER_USER_VAR',
                                                 passwordVariable: 'DOCKER_PASS_VAR')]) {
                    sh """
                        echo 'Logging into Docker Hub...'                        
                        echo "$DOCKER_PASS_VAR" | ${DOCKER_BIN} login -u $DOCKER_USER_VAR --password-stdin
                        
                        echo 'Pushing image to Docker Hub...'
                        ${DOCKER_BIN} push ${APP_IMAGE_NAME}:latest
                        
                        ${DOCKER_BIN} logout
                    """
                }
            }
        }

        stage('Deploy to K8s') {
            steps {
                dir('a2') {
                    sh "echo 'Applying K8s application manifests...'"
                    sh "${KUBECTL_BIN} apply -f ${K8S_MANIFEST_FILE} -n ${K8S_NAMESPACE}"                    
                    // 2. Wait for the rolling update to complete
                    sh "${KUBECTL_BIN} rollout status deployment/${K8S_DEPLOYMENT_NAME} -n ${K8S_NAMESPACE}"
                }
            }
        }
    }

    post {
        failure {
            sh "echo 'Pipeline failed. Check build logs for errors.'"
        }
        success {
            sh "echo 'Application deployed to K8s. Access via http://localhost:30000'"
        }
    }
}